-- Create database (run once)
CREATE DATABASE IF NOT EXISTS crypto_app CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
USE crypto_app;

-- Users table
CREATE TABLE IF NOT EXISTS users (
  id INT AUTO_INCREMENT PRIMARY KEY,
  name VARCHAR(255) DEFAULT NULL,
  email VARCHAR(255) NOT NULL UNIQUE,
  password VARCHAR(255) NOT NULL
) ENGINE=InnoDB;

-- Migration (if your users table already exists with password_hash column):
-- This will rename password_hash -> password while preserving data.
-- MySQL 8+ syntax:
-- ALTER TABLE users CHANGE password_hash password VARCHAR(255) NOT NULL;
-- If you need a name column:
-- ALTER TABLE users ADD COLUMN name VARCHAR(255) DEFAULT NULL AFTER password;

-- Cryptos table
CREATE TABLE IF NOT EXISTS cryptos (
  id INT AUTO_INCREMENT PRIMARY KEY,
  category VARCHAR(32) NOT NULL UNIQUE
) ENGINE=InnoDB;

-- Transactions table
CREATE TABLE IF NOT EXISTS transactions (
  id INT AUTO_INCREMENT PRIMARY KEY,
  user_id INT NOT NULL,
  crypto_category VARCHAR(32) NOT NULL,
  amount DECIMAL(18,8) NOT NULL,
  wallet_address VARCHAR(255) DEFAULT NULL,
  status VARCHAR(32) NOT NULL,
  CONSTRAINT fk_transactions_user FOREIGN KEY (user_id) REFERENCES users(id)
    ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB;

-- Seed default cryptos (idempotent)
INSERT INTO cryptos (category) VALUES
('BTC'),
('ETH'),
('USDT')
ON DUPLICATE KEY UPDATE category = VALUES(category);

